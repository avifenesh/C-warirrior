#!/usr/bin/env python3
"""
Convert ASCII map designs to world_config JSON format.
FIXED: All terminals are accessible with clear paths from spawn.
"""

import json

# Legend:
# # = wall (border only, interior walls carefully placed)
# . = floor (walkable)
# ~ = water (obstacle, decorative)
# T = terminal (quest location, MUST be on floor with clear path)
# @ = player spawn
# D = door

# REDESIGNED MAPS - Simple, guaranteed walkable layouts
# Rule: Terminals always have 1+ tile clearance, clear path from spawn
LEVEL_MAPS = {
    "L01": """
####################
#..................#
#..................#
#..................#
#..................#
#..................#
#....T.....T.....T.#
#@.................#
#..................#
#..................#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L02": """
####################
#..................#
#..................#
#..................#
#..................#
#..................#
#....T.....T.....T.#
#@.................#
#..................#
#.....~~.....~~....#
#.....~~.....~~....#
#..................#
#..................#
#..................#
####################
""",
    "L03": """
####################
#..................#
#.........T........#
#..................#
#..................#
#..................#
#....T.............#
#@.................#
#..................#
#..............T...#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L04": """
####################
#..................#
#.........T........#
#..................#
#..................#
#....T.............#
#..................#
#@.................#
#..................#
#..............T...#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L05": """
####################
#..................#
#....T.............#
#..................#
#..................#
#.........T........#
#..................#
#@.................#
#..................#
#..............T...#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L06": """
####################
#..................#
#.~~...........~~..#
#.~~...........~~..#
#..................#
#......T...T.......#
#..................#
#@.................#
#..................#
#.~~...........~~..#
#.~~...........~~..#
#..................#
#..................#
#..................#
####################
""",
    "L07": """
####################
#..................#
#.........T........#
#..................#
#..................#
#....T.............#
#..................#
#@.................#
#..................#
#..............T...#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L08": """
####################
#..................#
#..............T...#
#..................#
#..................#
#.........T........#
#..................#
#@.................#
#..................#
#....T.............#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L09": """
####################
#.~~~..........~~~.#
#.~~~..........~~~.#
#..................#
#....T.........T...#
#..................#
#..................#
#@.................#
#..................#
#.........T........#
#..................#
#.~~~..........~~~.#
#.~~~..........~~~.#
#..................#
####################
""",
    "L10": """
####################
#..................#
#..................#
#....T.........T...#
#..................#
#..................#
#..................#
#@.................#
#..................#
#..................#
#.........T........#
#..................#
#..................#
#..................#
####################
""",
    "L11": """
####################
#..................#
#.~~...........~~..#
#.~~...........~~..#
#..................#
#....T.........T...#
#..................#
#@.................#
#..................#
#.~~...........~~..#
#.~~...........~~..#
#..................#
#..................#
#..................#
####################
""",
    "L12": """
####################
#..................#
#....T.............#
#..................#
#..................#
#..................#
#.........T........#
#@.................#
#..................#
#..................#
#..............T...#
#..................#
#..................#
#..................#
####################
""",
    "L13": """
####################
#..................#
#..................#
#....T.............#
#..................#
#..................#
#.........T........#
#@.................#
#..................#
#..................#
#..............T...#
#..................#
#..................#
#..................#
####################
""",
    "L14": """
####################
#..................#
#..............T...#
#..................#
#..................#
#.........T........#
#..................#
#@.................#
#..................#
#....T.............#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L15": """
####################
#..................#
#....T.............#
#..................#
#..................#
#.........T........#
#..................#
#@.................#
#..................#
#..............T...#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L16": """
####################
#..................#
#....T.............#
#..................#
#..................#
#.........T........#
#..................#
#@.................#
#..................#
#..............T...#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L17": """
####################
#..................#
#..............T...#
#..................#
#.........T........#
#..................#
#..................#
#@.................#
#..................#
#....T.............#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L18": """
####################
#..................#
#....T.............#
#..................#
#..................#
#.........T........#
#..................#
#@.................#
#..................#
#..............T...#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L19": """
####################
#..................#
#....T.............#
#..................#
#..................#
#..................#
#.........T........#
#@.................#
#..................#
#..................#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L20": """
####################
#..................#
#....T.........T...#
#..................#
#..................#
#..................#
#.........T........#
#@.................#
#..................#
#..................#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L21": """
####################
#..................#
#.~~...........~~..#
#.~~...........~~..#
#..................#
#....T.........T...#
#..................#
#@.................#
#..................#
#.~~...........~~..#
#.~~...........~~..#
#..................#
#..................#
#..................#
####################
""",
    "L22": """
####################
#..................#
#....T.............#
#..................#
#..................#
#..................#
#.........T........#
#@.................#
#..................#
#..................#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L23": """
####################
#..................#
#....T.............#
#..................#
#..................#
#..................#
#.........T........#
#@.................#
#..................#
#..................#
#..................#
#..................#
#..................#
#..................#
####################
""",
    "L24": """
####################
#..................#
#.~~...........~~..#
#.~~...........~~..#
#..................#
#....T.........T...#
#..................#
#@.................#
#..................#
#.~~...........~~..#
#.~~...........~~..#
#..................#
#..................#
#..................#
####################
""",
    "L25": """
####################
#..................#
#....T.............#
#..................#
#..................#
#.........T........#
#..................#
#@.................#
#..................#
#..............T...#
#..................#
#..................#
#..................#
#..................#
####################
"""
}

# Quest IDs per level (matching the number of terminals)
QUEST_IDS = {
    "L01": ["L01_Q1", "L01_Q2", "L01_Q3"],
    "L02": ["L02_Q1", "L02_Q2", "L02_Q3"],
    "L03": ["L03_Q1", "L03_Q2", "L03_Q3"],
    "L04": ["L04_Q1", "L04_Q2", "L04_Q3"],
    "L05": ["L05_Q1", "L05_Q2", "L05_Q3"],
    "L06": ["L06_Q1", "L06_Q2"],
    "L07": ["L07_Q1", "L07_Q2", "L07_Q3"],
    "L08": ["L08_Q1", "L08_Q2", "L08_Q3"],
    "L09": ["L09_Q1", "L09_Q2", "L09_Q3"],
    "L10": ["L10_Q1", "L10_Q2", "L10_Q3"],
    "L11": ["L11_Q1", "L11_Q2"],
    "L12": ["L12_Q1", "L12_Q2", "L12_Q3"],
    "L13": ["L13_Q1", "L13_Q2", "L13_Q3"],
    "L14": ["L14_Q1", "L14_Q2", "L14_Q3"],
    "L15": ["L15_Q1", "L15_Q2", "L15_Q3"],
    "L16": ["L16_Q1", "L16_Q2", "L16_Q3"],
    "L17": ["L17_Q1", "L17_Q2", "L17_Q3"],
    "L18": ["L18_Q1", "L18_Q2", "L18_Q3"],
    "L19": ["L19_Q1", "L19_Q2"],
    "L20": ["L20_Q1", "L20_Q2", "L20_Q3"],
    "L21": ["L21_Q1", "L21_Q2"],
    "L22": ["L22_Q1", "L22_Q2"],
    "L23": ["L23_Q1", "L23_Q2"],
    "L24": ["L24_Q1", "L24_Q2"],
    "L25": ["L25_Q1", "L25_Q2", "L25_Q3"],
}

def parse_ascii_map(ascii_map: str, level_id: str) -> dict:
    """Parse ASCII map and return world_config."""
    lines = [line for line in ascii_map.strip().split('\n') if line]

    spawn_x, spawn_y = None, None
    terminals = []
    tiles = []

    for y, line in enumerate(lines):
        for x, char in enumerate(line):
            if char == '@':
                spawn_x = x * 32
                spawn_y = y * 32
            elif char == 'T':
                terminals.append({"x": x * 32, "y": y * 32})
            elif char == '~':
                tiles.append({"x": x, "y": y, "type": "water"})
            elif char == 'D':
                tiles.append({"x": x, "y": y, "type": "door"})

    # Assign quest IDs to terminals in order (left-to-right, top-to-bottom)
    terminals.sort(key=lambda t: (t["y"], t["x"]))
    quest_ids = QUEST_IDS.get(level_id, [])

    for i, terminal in enumerate(terminals):
        if i < len(quest_ids):
            terminal["quest_id"] = quest_ids[i]
        else:
            terminal["quest_id"] = f"{level_id}_Q{i+1}"

    world_config = {
        "width": 20,
        "height": 15,
        "spawn_x": spawn_x,
        "spawn_y": spawn_y,
        "terminals": terminals
    }

    # Add tiles array only if we have water/doors
    if tiles:
        world_config["tiles"] = tiles

    return world_config

def main():
    results = {}

    for level_id, ascii_map in LEVEL_MAPS.items():
        config = parse_ascii_map(ascii_map, level_id)
        results[level_id] = config

        # Print summary
        print(f"\n{level_id}:")
        print(f"  spawn: ({config['spawn_x']}, {config['spawn_y']})")
        print(f"  terminals: {len(config['terminals'])}")
        for t in config['terminals']:
            print(f"    - ({t['x']}, {t['y']}) -> {t['quest_id']}")
        if 'tiles' in config:
            print(f"  tiles: {len(config['tiles'])} (water/doors)")

    # Output full JSON
    print("\n\n=== FULL JSON OUTPUT ===\n")
    print(json.dumps(results, indent=2))

    # Save to file
    with open("/tmp/world_configs.json", "w") as f:
        json.dump(results, f, indent=2)
    print("\nSaved to /tmp/world_configs.json")

if __name__ == "__main__":
    main()
